*&H100
'CONWAY'S GAME OF LIFE
'SETUP PHASE

>START
MOVE 1 0 'DRAW STATE
ADDI !0 0 <LGRID % 'STORE IN GRID
MOVE <LGRID 14 'SET UP TOUCH SCREEN
SUBI &H300 11 13 % 'SET UP TOP SCREEN
REFR

>SETUP
;@BTN 'GET CURRENT BUTTON
G 4
JEI #A 4 <LIFESTART 'START LIFE?
JEI #B 4 <FLIP 'FLIP MODE?

;@@TOUCH 'GET VALIDATED TOUCH
REC &B110 'GET TOUCH INFO
JEI 0 2 <SETUP 'JUMP TO SETUP IF NO TOUCH
SUBI <LGRID 1 3 % 'GET GRID ADDRESS
DIVI 32 3 = % 'GET GADD % 32
JEI 0 3 <SETUP 'IGNORE 0TH COLUMN
STORER 0 1 'DRAW PIXEL
REFR
JUMP <SETUP

>FLIP
XORI 1 0 = 'FLIP STATE
ADDI !0 0 <LGRID % 'STORE IN GRID
REFR
JUMP <SETUP


'START LIFE PHASE
>LIFESTART
SWAP 13 14 'SWAP SCREEN POINTERS
STOREIM 0 <LGRID 'ERASE CURSOR REMINDER

'START A NEW GENERATION
>GEN
REFR
I 0 'PLACE TWO ZEROES ON THE STACK
I 0 'TO MARK THE BOTTOM
MOVE <LGRID 0 'R0=MEMORY CURSOR
ADDI &H300 0 1 % 'R1=LIMIT

>LIFELOOP
SUBI <LGRID 0 2 % 'R2=GRID CURSOR
DIVI 32 2 = % 'GET GRID % 32
JEI 0 2 <SKIP 'SKIP 0TH COLUMN

'SUM UP NEIGHBOURS INTO R3
MOVE 0 3 'RESET R3

ILOADR -32 0 4 'GET UP
ADDR 4 3 = % 'NEIGHBOUR++?

ILOADR 32 0 4 'GET DOWN
ADDR 4 3 = % 'NEIGHBOUR++?

ILOADR -1 0 4 'GET LEFT
ADDR 4 3 = % 'NEIGHBOUR++?

ILOADR 1 0 4 'GET RIGHT
ADDR 4 3 = % 'NEIGHBOUR++?

JLI+ 3 3 <CC 'IF NC>3, CELL IS DEAD

ILOADR -33 0 4 'GET UP LEFT
ADDR 4 3 = % 'NEIGHBOUR++?

ILOADR 33 0 4 'GET DOWN RIGHT
ADDR 4 3 = % 'NEIGHBOUR++?

ILOADR 31 0 4 'GET DOWN LEFT
ADDR 4 3 = % 'NEIGHBOUR++?

JLI+ 3 3 <CC 'IF NC>3, CELL IS DEAD
JEI 0 3 <CC 'SKIP LAST CHECK IF NEIGHBOUR COUNT IS ZERO

ILOADR -31 0 4 'GET UP RIGHT
ADDR 4 3 = % 'NEIGHBOUR++?

>CC 'CELL CHECK
ORR 3 ,0 4 'OR CURRENT CELL WITH NC
JNI 3 4 <DEAD 'IF THAT'S 3, IT'S LIVE

'LIVE CELL
>LIVE
JEI 1 ,0 <SKIP 'UNCHANGED?
R 0 'PUSH ADDRESS
I 1 'PUSH LIVE

'DEAD CELL
>DEAD
JEI 0 ,0 <SKIP 'UNCHANGED
R 0 'PUSH ADDRESS
I 0 'PUSH DEAD

>SKIP
JLR+ }0 1 <LIFELOOP 'REPEAT UNTIL WHOLE GRID IS DONE

'REFRESH THE GRID
>GRIDRF
;@BTN 'GET BUTTON
JEI #A .11 <END 'EXIT BUTTON PRESSED?

REC &B11
JEI 0 0 <END 'END IF GRID HAS STOPPED CHANGING
STORER 1 0 'STORE IT

>COPYLOOP
'RECEIVE &B11
JEI 0 ?1 <C_EXIT 'RESET?
STORER .11 = 'STORE IT
'REFR
JUMP <COPYLOOP

>C_EXIT
INC )11
JUMP <GEN

>END
MOVE &HF000 11 'RESET S11
MOVE &H0000 12 'RESET S12
JUMP <START

+&H20 'BUFFER SPACE
>LGRID

