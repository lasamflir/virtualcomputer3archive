*&H100
'QUICK LIFE
'CELLS ARE STORED AS STATE+NEIGHBOURS<<1
'CHANGING CELLS ARE STACKED

MOVE ;LIB_END 13
MOVE <PIXGRID 14
STOREM 14 ;_PIXEL_OFFSET


>START
STOREIM 0 ;_CUR 'RESET CURSOR
I <EDITORTEXT
;@BPRINT
STOREIR ! 13 'SHOW DRAW INDICATOR
REFR

>EDITOR
MOVE 1 0 'R0=MODE

>EDITORLOOP
BUTTON 1 'R1=BUTTON
JNI 0 1 <BTNHANDLE 'BUTTONS PRESSED?
TOUCH 1 = = 'R1=TOUCH
JNI 0 1 <TOUCHHANDLE 'SCREEN TOUCHED?
JUMP <EDITORLOOP

>BTNHANDLE
;@BTN 'GET BUTTON(S) PRESSED
G 1 'R1=BUTTON(S)
JEI #A 1 <EDITON
JEI #B 1 <EDITOFF
JEI 79 1 <EDITCLEAR
JEI #Y 1 <LS 'START
JUMP <EDITORLOOP

>EDITON
STOREIR ! 13 'SHOW DRAW INDICATOR
MOVE 1 0 'SET MODE
REFR
JUMP <EDITORLOOP

>EDITOFF
STOREIR ! 13 'SHOW DRAW INDICATOR
MOVE 0 0 'SET MODE
REFR
JUMP <EDITORLOOP

>EDITCLEAR
I <LIFEGRID
I <PIXEND
;@SE_LL
;@ERASE
JUMP <START

>TOUCHHANDLE
;@TOUCHPIX 'GET TOUCHED POSITION
REC &B1110 'R1=X, R2=Y, R3=T
FUNC _12 ;@PXCLIP 'LIMIT X,Y
REC &B110 'R1=X, R2=Y, R3=T
JEI 0 1 <EDITORLOOP 'IGNORE 0TH COLUMN
JEI 63 1 <EDITORLOOP 'IGNORE 63RD COLUMN
S &B110 'S X, Y
R 0 'S MODE
;@PXMODE 'SET PIXEL

S &B110 'S X,Y
R 0 'S MODE
<SETCELL

REFR
JUMP <EDITORLOOP


>SETCELL
PR &B111111 &B111 'GET X, Y, STATE
JEI 0 0 <X0 'IGNORE 0TH COLUMN
JEI 63 0 <X0 'IGNORE 63RD COLUMN
MULI 64 1 = = 'MULTIPLY UP Y
ADDR 0 1 0 % 'ADD IN Y
ADDI <LIFEGRID 0 = % 'GET CENTRE CELL
LOADR 0 3 'LOAD CELL
ANDI 1 3 4 'EXTRACT LAST BIT
ANDI &HFFFE 3 = 'ERASE LAST BIT
ORR 3 2 5 'OR STATE IN WITH NEIGHBOUR COUNT
STORER 5 0 'STORE CELL

JER 2 4 <X0 'UPDATE NEIGHBOURS?
FUNC _02 <NE++ 'SET NEIGHBOURS

>X0
EXIT &B111111

>NE++
PR &B111 &B11 'GET CELL, STATE
MULI 2 1 = = 'MULTIPLY STATE BY 2
SUBI 1 1 = % '-1 FOR DEAD, +1 FOR ALIVE
LEFTI 1 = = % 'SHIFT R1 1 LEFT

ILOADR -65 0 2 'GET UP LEFT NEIGHBOUR
ADDR 1 2 = % 'ADD TO IT
ISTORER 2 0 -65 'STORE NEIGHBOUR

ILOADR -64 0 2 'GET UP NEIGHBOUR
ADDR 1 2 = % 'ADD TO IT
ISTORER 2 0 -64 'STORE NEIGHBOUR

ILOADR -63 0 2 'GET UP RIGHT NEIGHBOUR
ADDR 1 2 = % 'ADD TO IT
ISTORER 2 0 -63 'STORE NEIGHBOUR

ILOADR -1 0 2 'GET LEFT NEIGHBOUR
ADDR 1 2 = % 'ADD TO IT
ISTORER 2 0 -1 'STORE NEIGHBOUR

ILOADR 1 0 2 'GET RIGHT NEIGHBOUR
ADDR 1 2 = % 'ADD TO IT
ISTORER 2 0 1 'STORE NEIGHBOUR

ILOADR 63 0 2 'GET DOWN LEFT NEIGHBOUR
ADDR 1 2 = % 'ADD TO IT
ISTORER 2 0 63 'STORE NEIGHBOUR

ILOADR 64 0 2 'GET DOWN NEIGHBOUR
ADDR 1 2 = % 'ADD TO IT
ISTORER 2 0 64 'STORE NEIGHBOUR

ILOADR 65 0 2 'GET DOWN RIGHT NEIGHBOUR
ADDR 1 2 = % 'ADD TO IT
ISTORER 2 0 65 'STORE NEIGHBOUR

EXIT &B111


>LS
SWAP 13 14

MOVE <LIFEGRID 0 'R0=CELL POINTER
SUBI &H300 11 14 %
MOVE <LEND <LENDP 'RESET END CURSOR

>LIFE
'REFR
I 0 'PASS SENTINEL VALUE
I 0

>LIFELOOP
JEI 0 ,0 <SKIP 'SKIP EMPTY CELLS::::::

JEI 5 ,0 <SKIP '5=2<<1+1 CELL LIVES
JEI 7 ,0 <SKIP '7=3<<1+1 CELL LIVES

ANDI 1 ,0 2 'GET CELL
JEI 1 2 <FLIP

ANDI &H3F 0 3 'GET COLUMN
JEI 0 3 <SKIP 'SKIP COLUMN?
JEI 63 3 <SKIP 'SKIP COLUMN?

JEI 6 ,0 <FLIP '6=3<<1 CELL IS BORN

>SKIP
JNR <LENDP }0 <LIFELOOP 'REPEAT UNTIL END OF GRID
'REFRESH THE GRID
>GRIDRF
REFR

'UPDATE END POINTER
ADDI &H42 ?1 <LENDP %
JGI+ <LEND <LENDP <RFC
MOVE <LEND <LENDP

>RFC
REC &B11
JEI 0 0 <END 'END IF GRID HAS STOPPED CHANGING
FUNC _01 <STORE 'STORE IT

>COPYLOOP
REC &B11
JEI 0 0 <LIFE_R 'RESET?
FUNC _01 <STORE 'STORE IT
'REFR
JUMP <COPYLOOP

>LIFE_R 'PREPARE TO RESET
;@BTN 'GET BUTTON
G 4 'R4=BUTTON
JEI #X 4 <END 'END IF X PRESSED

ILOADR -3 11 0 'GET NEW START OF LIFEGRID
SUBI &H41 0 = % 'COMPENSATE FOR PATTERN MOVEMENT
JLI+ <LIFEGRID 0 <LIFE 'START NEXT GENERATION
MOVE <LIFEGRID 0
JUMP <LIFE

HALT


>END
MOVE ;LIB_END 14
SWAP 13 14
JUMP <START

>UPDATE
PE &B111
SUBI <LIFEGRID 0 = % 'OFFSET
DIVI 64 0 = 1 'GET X AND Y
G 2 'GET STATE
FUNC _012 ;@PXMODE 'SET PIXEL
EXIT &B111

>FLIP
XORI 1 2 = 'FLIP CELL STATE
R 0 'PUSH ADDRESS
R 2 'PUSH STATE
R 2 'PUSH STATE
<UPDATE
JUMP <SKIP

>STORE
PR &B111 &B101
SUBI <LIFEGRID 0 = % 'OFFSET
DIVI 64 0 = 1 'GET X AND Y
FUNC _012 <SETCELL 'SET CELL
EXIT &B111






'>FLIP 'CHANGE A CELL
'XORI 1 2 = 'FLIP CELL STATE
'DIVI 64 0 3 4 'GET X AND Y
'S &B11000 'S X AND Y
'R 2 'S STATE
'<SETCELL 'SET CELL+NEIGHBOUR COUNTS
'S &B11000 'S X AND Y
'R 2 'S STATE
'<UPDATE 'UPDATE PIXELS
'JUMP <SKIP





>LENDP
<LEND

>EDITORTEXT
10
$ON OFF CLEAR! GO!
0
*&H1000
>LIFEGRID
+&HC00
>LEND
+&H1000
>PIXGRID
+&H300
>PIXEND

