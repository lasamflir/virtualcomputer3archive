*&H100
>START
;@CLRQUEUE 'ERASE THE QUEUE
MOVE 0 10 'RESET SCORE
MOVE ;LIB_END 14 'SET UP TOUCH SCREEN
MOVE <GAMESCREEN 13 'SET UP MAIN SCREEN
I 0
;@DEC
;@NL 'PRINT STARTING SCORE
REFR 'REFRESH

>IWAIT
BUTTON 0 'GET BUTTON
JEI 0 0 <IWAIT 'WAIT UNTIL SOMETHING'S PRESSED
'GAME START
MOVE <SSTART 0 'R0=SNAKE HEAD POSITION
R 0
;@FEQ 'ADD TO QUEUE
R 0
;@FEQ 'ADD TO QUEUE
'R 0
';@FEQ 'ADD TO QUEUE

MOVE #UP 1 'DIRECTION REGISTER
'R2-3=TIMING REGISTERS
MOVE 125 4 'R4=DELAY
'R5-9=SCRATCH
'R10=SCORE
<PLACEAPPLE 'INITIALLY PLACE FOOD
REFR

>MAIN 'GAME LOOP
MIL 3 = 'GET TIME
SUBR 2 3 = % 'GET DELAY
BUTTON 9 'GET BUTTON
JEI 0 9 <NOPRESS 'NO PRESS?
COPY 9 5 'RECORD BUTTON PRESS

>NOPRESS
JGR+ 4 3 <MAIN 'WAIT UNTIL DELAY HAS ELAPSED

>LOOP
<DECODEBTN
<DIRSUM 'CREATE DIRECTION SUM
ADDR 5 0 6 % 'GET NEXT SNAKE POSITION
LOADR 6 7 'READ NEXT SNAKE POSITION
JEI ! 7 <EAT 'DETECT FOOD
JNI 32 7 <GAMEOVER 'DETECT EVERYTHING ELSE

;@FDQ 'DEQUEUE TAIL POSITION
STOREIR 32 .11 'ERASE SNAKE TAIL

>EATRESUME
R 6 'PUSH NEW HEAD POSITION
;@FEQ 'ADD TO QUEUE
STOREIR ! 0 'DRAW SNAKE BODY
STOREIR ! 6 'DRAW SNAKE HEAD

COPY 6 0 'UPDATE HEAD POSITION

REFR
MOVE 0 5 'RESET R5
MIL 2 = 'GET TIME FOR TIMING LOOP
JUMP <MAIN

>PLACEAPPLE 'GENERATE FOOD
PE &B1100000
>PLOOP
RND 5 'GENERATE RANDOM NUMBER...
ANDI &H3FF 5 =
JLI+ &H2C0 5 <PLOOP 'WITHIN SCREEN
ADDI <GRIDSTART 5 = % 'OFFSET FOR SCREEN
LOADR 5 6 'GET CHARACTER FROM DISPLAY
JNI 32 6 <PLOOP 'RESET UNLESS SPACE
STOREIR ! 5 'PLACE FOOD
RE &B1100000
]

>DECODEBTN 'DECODE BUTTON PRESSES INTO DIRECTION FLAG
'BUTTON 5 'GET BUTTON PRESSES
JLI+ 15 5 <DRT 'REJECT OTHER BUTTONS
JEI 0 5 <DRT 'REJECT ZERO BUTTONS
JER 5 1 <DRT 'REJECT HELD PRESSES
NOT 1 6 'GENERATE NOT MASK
ANDR 6 5 = 'REMOVE CURRENT DIRECTION
JGI+ 3 1 <VERTICAL 'VERTICAL?

'DEALING WITH HORIZONTAL DIRECTION
ANDI &B1100 5 6 'GET HORIZONTALS
JNI 0 6 <DRT 'REJECT IRRELEVANT PRESSES
ANDI &B11 5 1 'SET DIRECTION
]

>VERTICAL
ANDI &B11 5 6 'GET VERTICALS
JNI 0 6 <DRT 'REJECT IRRELEVANT PRESSES
ANDI &B1100 5 1 'SET DIRECTION

>DRT 'RETURN
]

>DIRSUM 'CREATES DIRECTION SUM
JEI #UP 1 <DUP
JEI #DOWN 1 <DDOWN
JEI #LEFT 1 <DLEFT
JEI #RIGHT 1 <DRIGHT

>DUP
MOVE -32 5
]

>DDOWN
MOVE 32 5
]

>DLEFT
MOVE -1 5
]

>DRIGHT
MOVE 1 5
]

>EAT
INC 10 'SCORE++
DEC 4 'DELAY--
<SHOWSCORE
<PLACEAPPLE 'GENERATE MORE FOOD
JUMP <EATRESUME 'PREVENT DEQUEUE

>SHOWSCORE
I 8
I 6 'ERASE OLD SCORE
;@CHRREP
R 10
;@DEC 'DISPLAY SCORE
;@NL 'PRINT NEWLINE
]


>GAMEOVER 'ERASE SCREEN AND START OVER
MOVE <GRIDSTART 0

>SOLOOP
LOADR 0 1 'GET R0
JEI 32 1 <SKIP 'SKIP SPACE
JEI ! 1 <SKIP 'SKIP BORDER
STOREIR 32 0 'ERASE
REFR 'REFRESH

>SKIP
INC 0 'R0++
JNI <GRIDEND 0 <SOLOOP 'REPEAT UNTIL END
JUMP <START



>GAMESCREEN 'MAIN SCREEN FOR GAME
$
>GRIDSTART 'PLAYGRID STARTS HERE
$                              
$                              
$                              
$                              
$                              
$                              
$                              
$                              
$                              
$                              
$               
>SSTART 'SNAKE'S START POSITION
$               
$                              
$                              
$                              
$                              
$                              
$                              
$                              
$                              
$                              
$                              
$                              
>GRIDEND 'PLAYGRID ENDS HERE
$


